# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebSocket —á–µ—Ä–µ–∑ Supabase Realtime –∏ fallback –Ω–∞ polling.

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### Backend —Å–µ—Ä–≤–∏—Å—ã

#### `lib/services/SessionManager.ts`
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
- `getOrCreateSession()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `updateTopicId()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ topic_id –¥–ª—è Telegram
- `getSessionByTopicId()` - –ø–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏ –ø–æ topic_id
- `sessionExists()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏

#### `lib/services/TelegramService.ts`
–†–∞–±–æ—Ç–∞ —Å Telegram Bot API:
- `createForumTopic()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º—ã –≤ —Ñ–æ—Ä—É–º–µ
- `sendMessage()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–º—É
- `sendClientCard()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
- `sendUserMessage()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `setWebhook()` / `getWebhookInfo()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ webhook

#### `lib/services/WebSocketManager.ts`
–ú–µ–Ω–µ–¥–∂–µ—Ä WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è):
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ WebSocket
- –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ ping/pong

### API Endpoints

#### `POST /api/support/chat/send`
–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –°–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –°–æ–∑–¥–∞–µ—Ç —Ç–µ–º—É –≤ Telegram –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Realtime –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏

#### `GET /api/support/chat/poll`
–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (fallback):
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ü–æ–º–µ—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

#### `POST /api/telegram/webhook`
Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Realtime –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏

#### `POST /api/telegram/setup-webhook`
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### Frontend

#### `components/support-widget.tsx`
–í–∏–¥–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å:
- **Supabase Realtime** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Polling fallback** –µ—Å–ª–∏ Realtime –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–∞—Ç–∞

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
```
User ‚Üí POST /api/support/chat/send
  ‚Üí SessionManager.getOrCreateSession()
  ‚Üí TelegramService.createForumTopic() (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  ‚Üí saveSupportMessage() (–ë–î)
  ‚Üí TelegramService.sendUserMessage()
  ‚Üí sendRealtimeBroadcast() (–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
```
Admin (Telegram) ‚Üí POST /api/telegram/webhook
  ‚Üí SessionManager.getSessionByTopicId()
  ‚Üí saveSupportMessage() (–ë–î)
  ‚Üí sendRealtimeBroadcast() (–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞)
  ‚Üí SupportWidget –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ Realtime
  ‚Üí Fallback: polling –∫–∞–∂–¥—ã–µ 2.5 —Å–µ–∫
```

## üîå Realtime vs Polling

### Supabase Realtime (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ polling –ø—Ä–∏ –æ—à–∏–±–∫–µ

### Polling (fallback)
- –†–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ Realtime –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ó–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 2.5 —Å–µ–∫—É–Ω–¥—ã
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π, –Ω–æ –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ `lib/utils/logger.ts`:
- –ü—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤ production (–∫—Ä–æ–º–µ –æ—à–∏–±–æ–∫)

–ü—Ä–∏–º–µ—Ä—ã:
- `[Support]` - –ª–æ–≥–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- `[Telegram]` - –ª–æ–≥–∏ Telegram API
- `[Session]` - –ª–æ–≥–∏ —Å–µ—Å—Å–∏–π
- `[WebSocket]` - –ª–æ–≥–∏ WebSocket

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_SUPPORT_CHAT_ID=your_chat_id

# Supabase (–¥–ª—è Realtime)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
ENABLE_LOGGING=true  # –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏ –≤ production
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram

1. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É —Å —Ñ–æ—Ä—É–º–æ–º (Forum)
2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
3. –ü–æ–ª—É—á–∏—Ç–µ chat_id –≥—Ä—É–ø–ø—ã
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook: `POST /api/telegram/setup-webhook?url=https://your-domain.com/api/telegram/webhook`

## üöÄ –£–ª—É—á—à–µ–Ω–∏—è

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã (SessionManager, TelegramService)
- ‚úÖ Supabase Realtime –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ Polling fallback
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ JSON —Ñ–∞–π–ª
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- [ ] Rate limiting
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (–±–æ—Ç)
- [ ] –§–∞–π–ª—ã –∏ –º–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [TELEGRAM_SETUP.md](./TELEGRAM_SETUP.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Telegram
- [API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](./API_DOCUMENTATION.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API endpoints

