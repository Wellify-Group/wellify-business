# üöÄ –ß–¢–û –î–ê–õ–¨–®–ï - –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

## ‚úÖ –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∫–æ–¥ –≤ Supabase

### –î–ª—è DEV –ø—Ä–æ–µ–∫—Ç–∞:
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí –≤–∞—à **DEV –ø—Ä–æ–µ–∫—Ç**
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥:

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É user_id –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
ALTER TABLE public.email_verifications
  ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è user_id
CREATE INDEX IF NOT EXISTS idx_email_verifications_user_id 
  ON public.email_verifications(user_id);

-- –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
CREATE OR REPLACE FUNCTION confirm_user_email(user_id_param UUID)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE auth.users
  SET email_confirmed_at = NOW()
  WHERE id = user_id_param;
END;
$$;
```

4. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ **CTRL + Enter**
5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫

### –î–ª—è PRODUCTION (main) –ø—Ä–æ–µ–∫—Ç–∞:
–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ –∂–µ —à–∞–≥–∏, –Ω–æ –≤ **PRODUCTION Supabase –ø—Ä–æ–µ–∫—Ç–µ**.

---

## ‚úÖ –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –í Railway (wellify-auth-service):
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
- ‚úÖ `APP_BASE_URL` (–¥–ª—è DEV –∏ PRODUCTION —Ä–∞–∑–Ω—ã–µ)
- ‚úÖ `RESEND_API_KEY`
- ‚úÖ `EMAIL_FROM`
- ‚úÖ `SUPABASE_URL` (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- ‚úÖ `SUPABASE_SERVICE_ROLE_KEY` (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

### –í Vercel (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç):
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
- ‚úÖ `NEXT_PUBLIC_SUPABASE_URL_MAIN` / `_DEV`
- ‚úÖ `NEXT_PUBLIC_SUPABASE_ANON_KEY_MAIN` / `_DEV`
- ‚úÖ `SUPABASE_SERVICE_ROLE_KEY_MAIN` / `_DEV`

---

## ‚úÖ –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

### –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–∏–º—è, —Ñ–∞–º–∏–ª–∏—è, email, –ø–∞—Ä–æ–ª—å)
3. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ"
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ü–∏—Å—å–º–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email
   - ‚úÖ –í –ø–∏—Å—å–º–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email"
   - ‚úÖ –°—Å—ã–ª–∫–∞ –≤ –ø–∏—Å—å–º–µ –≤–µ–¥–µ—Ç –Ω–∞ `/api/auth/confirm-email?token=...`

### –¢–µ—Å—Ç 2: –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ
1. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email" –≤ –ø–∏—Å—å–º–µ
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "E-mail –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω" (—É—Å–ø–µ—Ö)
   - ‚úÖ –í Supabase `auth.users.email_confirmed_at` –∑–∞–ø–æ–ª–Ω–µ–Ω
   - ‚úÖ –í Supabase `profiles.email_verified = true`
   - ‚úÖ –í Supabase `email_verifications.used_at` –∑–∞–ø–æ–ª–Ω–µ–Ω

### –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ
1. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç—É –∂–µ —Å—Å—ã–ª–∫—É –µ—â–µ —Ä–∞–∑ (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "E-mail —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω"
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

### –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ polling –Ω–∞ —à–∞–≥–µ 2
1. –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞, –Ω–µ –∫–ª–∏–∫–∞—è –Ω–∞ —Å—Å—ã–ª–∫—É, –ø–æ–¥–æ–∂–¥–∏—Ç–µ
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ, polling –Ω–∞ —à–∞–≥–µ 2 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
   - ‚úÖ –®–∞–≥ 2 –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å "E-mail –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω"
   - ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —à–∞–≥ 3 (Telegram)

---

## üîç –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–∏—Å—å–º–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –õ–æ–≥–∏ Railway - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ –∏–∑ `/api/auth/send-custom-email-confirmation`
2. `RESEND_API_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Railway
3. `EMAIL_FROM` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Railway
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∞–º-–ø–∞–ø–∫—É

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ "column token does not exist"
**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SQL –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ Supabase
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `email_verifications` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ `token_hash` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ `token`!)

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ email
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –õ–æ–≥–∏ Railway - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ –∏–∑ `/api/auth/confirm-email`
2. –§—É–Ω–∫—Ü–∏—è `confirm_user_email` —Å–æ–∑–¥–∞–Ω–∞ –≤ Supabase
3. `SUPABASE_SERVICE_ROLE_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Railway

### –ü—Ä–æ–±–ª–µ–º–∞: Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase:**
1. –¢–∞–±–ª–∏—Ü–∞ `email_verifications` - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å —Å —Ç–æ–∫–µ–Ω–æ–º
2. `auth.users.email_confirmed_at` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
3. `profiles.email_verified` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `true` –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

---

## üìã –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] SQL –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ DEV Supabase –ø—Ä–æ–µ–∫—Ç–µ
- [ ] SQL –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ PRODUCTION Supabase –ø—Ä–æ–µ–∫—Ç–µ
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤ Railway
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤ Vercel
- [ ] –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –¢–µ—Å—Ç 2: –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- [ ] –¢–µ—Å—Ç 4: Polling –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é!

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º —á–µ—Ä–µ–∑ Resend
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email –ø–æ —Ç–æ–∫–µ–Ω—É
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ/–ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î
- ‚úÖ Polling –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

