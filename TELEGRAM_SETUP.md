# Инструкция по настройке Telegram интеграции для поддержки

## Описание системы

Система позволяет:
- ✅ Пользователи пишут сообщения в чат-окне на сайте
- ✅ Каждое сообщение пользователя создает отдельную тему (thread) в группе Telegram
- ✅ Администратор отвечает в Telegram в соответствующей теме
- ✅ Ответы из Telegram автоматически появляются у пользователя в чат-окне на сайте

**Важно:** Каждый отдельный диалог (CID) создает отдельную тему в группе Telegram, что позволяет легко управлять множественными запросами поддержки.

## Требования

1. Telegram группа с включенными темами (Forum)
2. Telegram бот с токеном
3. Переменные окружения в `.env.local`

## Шаг 1: Создание Telegram группы с темами

1. Создайте новую группу в Telegram
2. Перейдите в настройки группы → **Тип группы**
3. Выберите **Форум** (Forum)
4. Сохраните изменения

## Шаг 2: Создание бота и получение токена

1. Найдите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен (например: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

## Шаг 3: Добавление бота в группу

1. Откройте созданную группу (форум)
2. Перейдите в настройки группы → **Участники** → **Добавить участников**
3. Найдите вашего бота по имени и добавьте его
4. **Важно**: Сделайте бота администратором группы с правами:
   - Управление темами
   - Отправка сообщений

## Шаг 4: Получение ID группы

1. Добавьте бота [@userinfobot](https://t.me/userinfobot) в группу
2. Бот автоматически отправит ID группы
3. Сохраните этот ID (например: `-1001234567890`)

**Альтернативный способ:**
- Отправьте сообщение в группу
- Перейдите по ссылке: `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
- Найдите `chat.id` в ответе

## Шаг 5: Настройка переменных окружения

Добавьте в файл `.env.local`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_SUPPORT_CHAT_ID=id_вашей_группы
```

**Пример:**
```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_SUPPORT_CHAT_ID=-1001234567890
```

## Шаг 6: Настройка Webhook

Webhook нужен для получения сообщений из Telegram. Настройте его одним из способов:

### Способ 1: Через API Telegram (рекомендуется)

Выполните команду в терминале (замените значения):

```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-domain.com/api/telegram/webhook"}'
```

**Для локальной разработки** используйте ngrok или аналогичный сервис:

```bash
# Установите ngrok: https://ngrok.com/
ngrok http 3000

# Используйте полученный URL (например: https://abc123.ngrok.io)
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://abc123.ngrok.io/api/telegram/webhook"}'
```

### Способ 2: Через BotFather

1. Откройте [@BotFather](https://t.me/BotFather)
2. Отправьте `/setwebhook`
3. Отправьте URL вашего webhook: `https://your-domain.com/api/telegram/webhook`

## Шаг 7: Проверка работы

1. Откройте сайт и отправьте сообщение в чат поддержки
2. Проверьте, что в Telegram группе создалась новая тема
3. Ответьте на сообщение в Telegram
4. Проверьте, что ответ появился в чат-окне на сайте

## Проверка webhook

Проверить статус webhook можно командой:

```bash
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
```

## Устранение проблем

### Сообщения не приходят в Telegram

1. Проверьте, что бот добавлен в группу и является администратором
2. Проверьте правильность `TELEGRAM_BOT_TOKEN` и `TELEGRAM_SUPPORT_CHAT_ID`
3. Проверьте логи сервера на наличие ошибок

### Ответы из Telegram не приходят на сайт

1. Проверьте, что webhook настроен правильно
2. Проверьте, что сообщения отправляются в теме (thread), а не в основной группе
3. Проверьте логи сервера на наличие ошибок

### Тема не создается

1. Убедитесь, что группа настроена как форум (Forum)
2. Убедитесь, что бот имеет права на создание тем
3. Проверьте логи сервера на наличие ошибок

## Структура базы данных

Система использует две таблицы в Supabase:

- `support_sessions` - сессии пользователей (один CID = одна сессия = одна тема)
- `support_messages` - все сообщения от пользователей и поддержки

Миграция находится в файле `supabase_migration_support.sql`

## API Endpoints

- `POST /api/support/chat/send` - отправка сообщения от пользователя
- `GET /api/support/chat/poll` - получение новых сообщений от поддержки
- `POST /api/telegram/webhook` - webhook для получения сообщений из Telegram

