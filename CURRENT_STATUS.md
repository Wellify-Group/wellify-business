# üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Email

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:

1. ‚úÖ **–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω:**
   - –°–æ–∑–¥–∞–Ω `/api/auth/send-custom-email-confirmation` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∏—Å–µ–º
   - –°–æ–∑–¥–∞–Ω `/api/auth/confirm-email` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É
   - –ò–∑–º–µ–Ω–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - –æ—Ç–∫–ª—é—á–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ Supabase
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ `tokenHash`)
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

2. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞:**
   - `FINAL_SETUP_CHECKLIST.md` –æ–±–Ω–æ–≤–ª–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã

## ‚ö†Ô∏è –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**–û—à–∏–±–∫–∞ 500** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email.

## üîç –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

### 1. SQL –≤ Supabase (–ö–†–ò–¢–ò–ß–ù–û!)

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `email_verifications` —Å–æ–∑–¥–∞–Ω–∞ —Å **–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π** —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```sql
CREATE TABLE IF NOT EXISTS email_verifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, -- –ú–æ–∂–µ—Ç –±—ã—Ç—å NULL
  email TEXT NOT NULL,
  token_hash TEXT NOT NULL UNIQUE, -- –•–µ—à —Ç–æ–∫–µ–Ω–∞ (SHA256)
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  used_at TIMESTAMPTZ, -- –ö–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours') NOT NULL
);
```

**–í–ê–ñ–ù–û:** 
- –ö–æ–ª–æ–Ω–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `token_hash` (–ù–ï `token`)
- –ö–æ–ª–æ–Ω–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `used_at` (–ù–ï `verified_at`)
- `user_id` –º–æ–∂–µ—Ç –±—ã—Ç—å NULL (–±–µ–∑ NOT NULL)

–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ —Å—Ç–∞—Ä–æ–º—É SQL, —É–¥–∞–ª–∏—Ç–µ –µ—ë –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ:
```sql
DROP TABLE IF EXISTS email_verifications;
-- –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ CREATE TABLE –≤—ã—à–µ
```

### 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:

**–î–ª—è Production:**
- `RESEND_API_KEY`
- `EMAIL_FROM`
- `SUPABASE_SERVICE_ROLE_KEY` (–∏–ª–∏ `SUPABASE_SERVICE_ROLE_KEY_MAIN`)
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

**–î–ª—è Preview/Development:**
- `RESEND_API_KEY`
- `EMAIL_FROM`
- `SUPABASE_SERVICE_ROLE_KEY` (–∏–ª–∏ `SUPABASE_SERVICE_ROLE_KEY_DEV`)
- `NEXT_PUBLIC_SUPABASE_URL` (–∏–ª–∏ `NEXT_PUBLIC_SUPABASE_URL_DEV`)
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` (–∏–ª–∏ `NEXT_PUBLIC_SUPABASE_ANON_KEY_DEV`)

### 3. –õ–æ–≥–∏ Vercel

–ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard
2. –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí Functions
3. –ù–∞–π–¥–∏—Ç–µ `/api/auth/send-custom-email-confirmation`
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞
5. –¢–∞–º –±—É–¥–µ—Ç —Ç–æ—á–Ω–∞—è –æ—à–∏–±–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel
3. ‚úÖ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Vercel –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–∫–∏
5. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:

- **"column token does not exist"** ‚Üí –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (`token` –≤–º–µ—Å—Ç–æ `token_hash`)
- **"column verified_at does not exist"** ‚Üí –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (`verified_at` –≤–º–µ—Å—Ç–æ `used_at`)
- **"Missing SUPABASE_SERVICE_ROLE_KEY"** ‚Üí –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **"Failed to send email"** ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ —Å `RESEND_API_KEY` –∏–ª–∏ API Resend

